# Exercise 1

**Q1**: Where are these hundreds of functions?

**Answer**: In the libraries that we include.

**Q2**: Explore the program. What does it do? Where is the vulnerability?

**Answer**:

It asks user input for an unsinged integer (corresponding to the index of the airline company) and then for the user's name (array of char). Then it checks if the chosen airline is within the lists of *bookings*.

I have disabled ASLR so the addresses are not randomized, which means a quick inspection of the binary generated by running `make ex1` can give me details about the addresses of functions, variables and where are the sections of the binary located in the memory.

Since the user is prompted for input, we can use the buffer overflow attack.

**Q3**: How does ret2libc fit into this? What are some nice libc functions for exploitation?

**Answer**:

 Since there is no interesting function written by the programmer here that we can call to get a shell, we can use a function from the `libc` library to get a shell. Some nice libc functions that I can think of are `execve` (that we used in the last lab) and `system`.

**Q4**: Can we get a shell with this program? How?

**Answer**:

We can use the buffer overflow exploit and overwrite the return adress with the address of the `system` function from the `libc` library.

The address of the `system` function: `0x7ffff7c4b980` from:

```bash
pwndbg> info address system
Symbol "system" is at 0x7ffff7c4b980 in a file compiled without debugging.
```

The address of the `name` variable is `0x7fffffffd410`:

```bash
pwndbg> p &name
$1 = (char (*)[64]) c
```

How many bytes to overwrite until we get to overwrite the return address:

```bash
pwndbg> p (long)($rbp+8) - (long)(&name)
$5 = 344
```

Search for the string "/bin/sh" in `libc.so.6`:

```bash
pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
             Start                End Perm     Size Offset File
          0x400000           0x401000 r--p     1000      0 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x401000           0x402000 r-xp     1000   1000 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x402000           0x403000 r--p     1000   2000 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x403000           0x404000 r--p     1000   2000 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x404000           0x405000 rw-p     1000   3000 /home/aapostol/workspace/osds/lab3/bin/ex1
    0x7ffff7c00000     0x7ffff7c28000 r--p    28000      0 /usr/lib64/libc.so.6
    0x7ffff7c28000     0x7ffff7d9d000 r-xp   175000  28000 /usr/lib64/libc.so.6
    0x7ffff7d9d000     0x7ffff7df5000 r--p    58000 19d000 /usr/lib64/libc.so.6
    0x7ffff7df5000     0x7ffff7df9000 r--p     4000 1f5000 /usr/lib64/libc.so.6
    0x7ffff7df9000     0x7ffff7dfb000 rw-p     2000 1f9000 /usr/lib64/libc.so.6
    0x7ffff7dfb000     0x7ffff7e08000 rw-p     d000      0 [anon_7ffff7dfb]
    0x7ffff7fb5000     0x7ffff7fba000 rw-p     5000      0 [anon_7ffff7fb5]
    0x7ffff7fc1000     0x7ffff7fc5000 r--p     4000      0 [vvar]
    0x7ffff7fc5000     0x7ffff7fc7000 r-xp     2000      0 [vdso]
    0x7ffff7fc7000     0x7ffff7fc9000 r--p     2000      0 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7fc9000     0x7ffff7ff0000 r-xp    27000   2000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7ff0000     0x7ffff7ffb000 r--p     b000  29000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7ffb000     0x7ffff7ffd000 r--p     2000  34000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7ffd000     0x7ffff7fff000 rw-p     2000  36000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffffffdd000     0x7ffffffff000 rw-p    22000      0 [stack]
0xffffffffff600000 0xffffffffff601000 --xp     1000      0 [vsyscall]
pwndbg> find 0x7ffff7c00000,0x7ffff7df9000,"/bin/sh"
0x7ffff7db8171
```

## Exercise 2


**Q5**:  Explore the program. What does it do? Where is the vulnerability?

**Answer**:

The program outputs a bunch of strings on the stdout.
It asks for user input.
Then calls `memcpy` to copy into `bad_nightmare` the whole of `souldream` (256 bytes). This could be a security risk.

**Q6**: Dump the ROP gadgets from the binary. Look at them and think which might be useful and why.

**Answer**: 

```bash
ROPgadget --binary ./bin/ex2 --only "mov|pop|xor|ret"
```

**Q7**: How would you call `dream_msg()` with one of the strings in the binary using a ROP chain? Try it.

**Answer**:

The address of `ephemereal` variable is:

```bash
pwndbg> p &ephemereal 
$2 = (char (*)[8]) 0x404048 <ephemereal>
```

The address of the `dream_msg` functio is:

```bash
pwndbg> info address dream_msg 
Symbol "dream_msg" is a function at address 0x401166.
```

```bash
pwndbg> p &souldream 
$1 = (char (*)[256]) 0x404080 <souldream>
```
